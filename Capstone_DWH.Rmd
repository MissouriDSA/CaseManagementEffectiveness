---
title: "Effectiveness of Care Coordination on Avoidable Emergency Utilization"
author: "David Hedrick"
date: "March 6, 2018"
output: 
  html_document:
    toc: true
    css: styles.css

---

<script src = "hideOutput.js"></script>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

[**Partners For Kids (PFK)**](http://partnersforkids.org) is a fully-capitated accountable care organization serving the 330,000 Medicaid Managed Care children in Central and Southeast Ohio (Figure 1 below), and is affiliated with Nationwide Children's Hospital (NCH) in Columbus, OH. Many accountable care organizations across the nation run on a shared savings model with Medicare, Medicaid or commercial insurers, where the organization splits savings below a specified financial target with the insurer. 

However, PFK does not operate on this model. Instead, they are fully at-risk for every member's medical, dental, vision and pharmacy expenses. Moreover, while many accountable care organizations are part of a clinically-integrated network, PFK is not; meaning they are responsible for members' expenses at providers and institutions outside the Nationwide Children's health system, in addition to the expenses occurring at Nationwide Children's.

**Figure 1: Partners for Kids covered counties**
<center>
![](images/PFK-Map.png)
</center>
## Why Care Coordination?

Care Coordination is one of many mechanisms by which Partners For Kids manages the health of the pediatric Medicaid Managed Care Population. Generally speaking, healthier kids are less expensive kids, which results in a shared success for patients and insurers alike. By incorporating the largest pediatric provider in the PFK region, providers can also share in that success.

Moreover, the Care Coordination service is required of all five Medicaid Managed Care Plans in Ohio. The five plans include **CareSource, Molina Healthcare, UnitedHealthcare Community Plan, Buckeye Community Health Plan (Centene), and Paramount Healthcare.** These plans can opt to fulfill this responsibility themselves, or **delegate** the responsibility to a third party entity like Partners for Kids. 

**The delegation arrangement is a separate arrangement from the capitation (financial risk) arrangement.** A plan can be in a capitation arrangement with PFK, but choose not to be in a delegation arrangement with PFK for Care Coordination.

Partners for Kids is financially at-risk for approximately 330,000 pediatric members in all five plans; however, they only have a delegation arrangement with four plans (every plan excluding CareSource). UnitedHealthcare did not begin their delegation arrangement with PFK until late 2017; therefore, this analysis will be limited to the three remaining plans **(Molina, Buckeye, and Paramount)**, which make up approximately 119,000 (36%) of the entire PFK population.

## Who Does PFK Target for Care Coordination?

PFK aims to target and manage members with:

* High Cost
* Frequent Inpatient Utilization
* Frequent Emergency Department Utilization
* Severe Chronic and Behavioral Health Conditions

Children in custody of the state and those adopted out of state custody were carved-out (not included) of the managed care population until January 1, 2017, and remained on the traditional fee-for-service model (and therefore not covered by PFK) until that time. Since 2017 largely consists of the measurement period for this analysis, children in custody and adopted children are excluded from this analysis by default.

## The Measurement: Avoidable Emergency Department Utilization

The New York University Wagner School of Public Service has developed an [algorithm](https://wagner.nyu.edu/faculty/billings/nyued-background#) to classify emergency department utilization into several categories:

* **Non-emergent** - The patient's initial complaint, presenting symptoms, vital signs, medical history, and age indicated that immediate medical care was not required within 12 hours;

* **Emergent/Primary Care Treatable** - Based on information in the record, treatment was required within 12 hours, but care could have been provided effectively and safely in a primary care setting. The complaint did not require continuous observation, and no procedures were performed or resources used that are not available in a primary care setting (e.g., CAT scan or certain lab tests);

* **Emergent - ED Care Needed** - Preventable/Avoidable - Emergency department care was required based on the complaint or procedures performed/resources used, but the emergent nature of the condition was potentially preventable/avoidable if timely and effective ambulatory care had been received during the episode of illness (e.g., the flare-ups of asthma, diabetes, congestive heart failure, etc.); and

* **Emergent - ED Care Needed** - Not Preventable/Avoidable - Emergency department care was required and ambulatory care treatment could not have prevented the condition (e.g., trauma, appendicitis, myocardial infarction, etc.).

For the purposes of this analysis, the categories listed in Figure 2 below will be used to measure the effectiveness of the Care Coordination program on Avoidable Emergency Utilization.

**Figure 2: NYU Algorithm for Avoidable ED Visits**

<center>
![](images/NYU_ED_Diagram.png)
</center>

## The Problem: Selection Bias

Since PFK is targeting the highest-risk members for inclusion in the Care Coordination program (including those with already-frequent emergency utilization), there is a selection bias between the enrolled (treated) and non-enrolled (not treated) populations.

Therefore, comparing the unadjusted outcomes between those who received the Care Coordination intervention to those who did not receive the intervention is a virtually meaningless analysis.

**Solution**: match enrolled members with similar non-enrolled members using logistic regression and compare outcomes of like members.



## The Data  

To begin, we'll load the dataset, which is a member-level detail of all qualifying members in 2016. Perhaps the most important field to understand is the **anchor_date**, since many of the other fields use it as a chronological frame of reference. All fields are described in detail below.

<div class="fold s o">
```{r, message=FALSE,warning=FALSE}
library(MatchIt)
library(dplyr)
library(knitr)
library(ggplot2)
library(sqldf)
library(tidyr)
library(plotly)
library(kableExtra)
library(shiny)
library(rateratio.test)
path <- "data_20180302.csv"
data <- read.csv(path, sep = ",")
names(data)

```
</div>
####What Do These Fields Mean?

```{r, echo=FALSE}
descriptions <- read.csv("data_descriptions.csv")
kable(descriptions, "html") %>%
    kable_styling(bootstrap_options = c("striped","hover","condensed","responsive")) %>%
    scroll_box(width="920px",height="300px")
```  
#### Data Carpentry  
Next, we'll do some data carpentry on these fields to make them usable in a logistic regression propensity match.

<div class="fold s o">
```{r}
data$FRANKLIN_COUNTY <- as.factor(data$FRANKLIN_COUNTY)
data$ENROLLED_IN_PERIOD <- as.factor(data$ENROLLED_IN_PERIOD)
data$NCH_Previous <- as.factor(data$NCH_Previous)
data$NCH_Inpatient <- as.factor(data$NCH_Inpatient)
data$PRIM_DX_HCUP_CHRONIC <- as.factor(data$PRIM_DX_HCUP_CHRONIC)
data$PRIM_DX_BH <- as.factor(data$PRIM_DX_BH)
data$ABD_FLAG <- as.factor(data$ABD_FLAG)
data$PREV_ASTHMA_ED <- as.factor(data$PREV_ASTHMA_ED)
data$PREV_DIABETES_ED <- as.factor(data$PREV_DIABETES_ED)
data$homehealth_flag <- as.factor(data$homehealth_flag)
data$NCH_ATTRIBUTED_ASSIGNED <- as.factor(data$NCH_ATTRIBUTED_ASSIGNED)
data$ABUSE_NEGLECT <- as.factor(data$ABUSE_NEGLECT)
data$NOT_WITH_PARENTS <- as.factor(data$NOT_WITH_PARENTS)
data$AVOIDABLE_ED_LAST_12_FLAG <- as.factor(data$AVOIDABLE_ED_LAST_12_FLAG)
data$PREV_AVOIDABLE_ED_VISIT <- as.factor(data$PREV_AVOIDABLE_ED_VISIT)
data$OVER_10K_PAID <- as.factor(data$OVER_10K_PAID)
data$IP_LAST_12_FLAG <- as.factor(data$IP_LAST_12_FLAG)
data$ED_VISIT_FLAG_5 <- as.factor(data$ED_VISIT_FLAG_5)

data[c("MRN")][is.na(data[c("MRN")])] <- 0
data <- data %>%
  na.omit()

```
</div>

## Propensity Scores and Propensity Matching

First, we'll calculate the propensity score to receive the Care Coordination intervention (the dependent variable) on the entire population. This data will be used later to evaluate the effectiveness of the match.

<div class="fold s o">
```{r}
ps <- glm(ENROLLED_IN_PERIOD ~ FRANKLIN_COUNTY 
          + NCH_Previous + OVER_10K_PAID + ED_VISIT_FLAG_5 + NCH_Inpatient
          + PRIM_DX_HCUP_CHRONIC + PRIM_DX_BH + ABD_FLAG + IP_LAST_12_FLAG
          + homehealth_flag + NCH_ATTRIBUTED_ASSIGNED
          + AVOIDABLE_ED_LAST_12_FLAG, 
          family = binomial(), data = data)


ps_df <- data.frame(pr_score = predict(ps,type = "response"),
                    ENROLLED_IN_PERIOD = ps$model$ENROLLED_IN_PERIOD, 
                    MEDICAIDID = data$MEDICAIDID)
options(scipen = 999)
summary(ps)

```
</div>

#### Match on Propensity Scores

Next, we'll match enrolled members (ENROLLED_IN_PERIOD = 1) with non-enrolled members so that we can effectively compare the two groups. We'll use the nearest neighbor method of propensity matching, which finds a match for a treated member based on the non-treated member with the propensity score closest in value to them.

[**More info on propensity matching**](https://umanitoba.ca/faculties/health_sciences/medicine/units/chs/departmental_units/mchp/protocol/media/propensity_score_matching.pdf) 

<div class="fold s o">
```{r}
matched <- matchit(ENROLLED_IN_PERIOD ~ FRANKLIN_COUNTY 
                   + NCH_Previous + OVER_10K_PAID + ED_VISIT_FLAG_5 + NCH_Inpatient
                   + PRIM_DX_HCUP_CHRONIC + PRIM_DX_BH + ABD_FLAG + IP_LAST_12_FLAG
                   + homehealth_flag + NCH_ATTRIBUTED_ASSIGNED
                   + AVOIDABLE_ED_LAST_12_FLAG, 
                   method = "nearest", data = data)
matched_data <- match.data(matched)
summary(matched)
```
</div>

#### Plot Frequency of Matched Members by Propensity Score

Since the number of members who received the intervention in 2016 is 1760, and given every member was able to be matched to a non-treated member, the number of members in the matched populations is exactly double 1760, or 3520. They've been plotted below using a frequency polygon to display the "closeness" of the match.

<div class="fold s">
```{r warning=FALSE}

setwd("plots")
p <- ggplot(ps_df, aes(pr_score, colour = ENROLLED_IN_PERIOD)) +
  geom_density(aes(fill=ENROLLED_IN_PERIOD,COLOUR = ENROLLED_IN_PERIOD), alpha = 0.3) + 
  labs(x="Propensity to Enroll",y="Density") +
  theme_bw() +
  ggtitle("Treated vs Non-Treated Propensity Scores - Pre Match")
p <- ggplotly(p)



p1 <- ggplot(matched_data, aes(distance, colour = ENROLLED_IN_PERIOD)) +
  geom_density(aes(fill=ENROLLED_IN_PERIOD,COLOUR = ENROLLED_IN_PERIOD), alpha = 0.3) + 
  labs(x="Propensity to Enroll",y="Density") +
  theme_bw() +
  ggtitle("Treated vs Non-Treated Propensity Scores - Post Match")

p1<-ggplotly(p1)
htmlwidgets::saveWidget(as.widget(p),"Pre-Match.html")
htmlwidgets::saveWidget(as.widget(p1),"Post-Match.html")

library(stringr)
library(bsselectR)
plots <- paste0(list.files(path=getwd(),full.names = FALSE))
names(plots) <- str_replace_all(plots,c(".html" = "","plots/"=""))
bsselect(plots, type = "iframe", select = "Pre-Match",live_search = TRUE,show_tick=TRUE)

```
</div>

#### Evaluation of Selection Bias Removal

To evaluate the selection bias removal, we'll compare the the values of the independent variables in the treated and non-treated populations before and after the propensity match. There will be a series of plots to visualize the removal, as well as p-values to determine if there is any statisical difference between the post-match treated and non-treated populations. Generally speaking, the green and red bars are quite unequal prior to the match, and it's desirable for the bars to become closer to equal after the propensity match, as well as the p-values to be greater than 0.05.

<div class="fold s o">
```{r}
df1<-sqldf('
  
select

a.ENROLLED_IN_PERIOD,
cast(sum(a.FRANKLIN_COUNTY) as float)/cast(count(a.FRANKLIN_COUNTY) as float) as percent_franklin,
cast(sum(NCH_Previous) as float)/cast(count(NCH_Previous) as float) as NCH_PREV_COUNT,
cast(sum(OVER_10K_PAID) as float)/cast(count(OVER_10K_PAID) as float) as PERCENT_OVER_10K,
cast(sum(ED_VISIT_FLAG_5) as float)/cast(count(ED_VISIT_FLAG_5) as float) as PERCENT_ED_5,
cast(sum(NCH_Inpatient) as float)/cast(count(NCH_Inpatient) as float) as percent_NCH_Inpatient,
cast(sum(PRIM_DX_HCUP_CHRONIC) AS float)/cast(count(PRIM_DX_HCUP_CHRONIC) as float) as percent_HCUP_Chronic,
cast(sum(PRIM_DX_BH) as float)/cast(count(PRIM_DX_BH) as float) as percent_BH,
cast(sum(ABD_FLAG) as float)/cast(count(ABD_FLAG) as float) as percent_ABD,
cast(sum(PREV_DIABETES_ED) as float)/cast(count(PREV_DIABETES_ED) as float) as percent_DIABETES,
cast(sum(homehealth_flag) as float)/cast(count(homehealth_flag) as float) as percent_HOMEHEALTH,
cast(sum(NCH_ATTRIBUTED_ASSIGNED) as float)/cast(count(NCH_ATTRIBUTED_ASSIGNED) as float) as percent_NCHATTR,
cast(sum(IP_LAST_12_FLAG) as float)/cast(count(IP_LAST_12_FLAG) as float) as PERCENT_IP_LAST_12,
cast(sum(AVOIDABLE_ED_LAST_12_FLAG) as float)/cast(count(AVOIDABLE_ED_LAST_12_FLAG) as float) as percent_AVOIDL12
  
from 
data a
group by
a.ENROLLED_IN_PERIOD
  
  
  
')
df3<-sqldf('
           
           select
           
           a.ENROLLED_IN_PERIOD,
           cast(sum(a.FRANKLIN_COUNTY) as float)/cast(count(a.FRANKLIN_COUNTY) as float) as percent_franklin,
           cast(sum(NCH_Previous) as float)/cast(count(NCH_Previous) as float) as NCH_PREV_COUNT,
           cast(sum(OVER_10K_PAID) as float)/cast(count(OVER_10K_PAID) as float) as PERCENT_OVER_10K,
           cast(sum(ED_VISIT_FLAG_5) as float)/cast(count(ED_VISIT_FLAG_5) as float) as PERCENT_ED_5,
           cast(sum(NCH_Inpatient) as float)/cast(count(NCH_Inpatient) as float) as percent_NCH_Inpatient,
           cast(sum(PRIM_DX_HCUP_CHRONIC) AS float)/cast(count(PRIM_DX_HCUP_CHRONIC) as float) as percent_HCUP_Chronic,
           cast(sum(PRIM_DX_BH) as float)/cast(count(PRIM_DX_BH) as float) as percent_BH,
           cast(sum(ABD_FLAG) as float)/cast(count(ABD_FLAG) as float) as percent_ABD,
           cast(sum(PREV_DIABETES_ED) as float)/cast(count(PREV_DIABETES_ED) as float) as percent_DIABETES,
           cast(sum(homehealth_flag) as float)/cast(count(homehealth_flag) as float) as percent_HOMEHEALTH,
           cast(sum(NCH_ATTRIBUTED_ASSIGNED) as float)/cast(count(NCH_ATTRIBUTED_ASSIGNED) as float) as percent_NCHATTR,
           cast(sum(IP_LAST_12_FLAG) as float)/cast(count(IP_LAST_12_FLAG) as float) as PERCENT_IP_LAST_12,
           cast(sum(AVOIDABLE_ED_LAST_12_FLAG) as float)/cast(count(AVOIDABLE_ED_LAST_12_FLAG) as float) as percent_AVOIDL12

from 
           matched_data a
           group by
           a.ENROLLED_IN_PERIOD
           ')

df2<-sqldf('
           
           select
           
           a.ENROLLED_IN_PERIOD,
           cast(sum(a.FRANKLIN_COUNTY) as float)/cast(count(a.FRANKLIN_COUNTY) as float) as percent_franklin,
           cast(sum(NCH_Previous) as float)/cast(count(NCH_Previous) as float) as NCH_PREV_COUNT,
           cast(sum(OVER_10K_PAID) as float)/cast(count(OVER_10K_PAID) as float) as PERCENT_OVER_10K,
           cast(sum(ED_VISIT_FLAG_5) as float)/cast(count(ED_VISIT_FLAG_5) as float) as PERCENT_ED_5,
           cast(sum(NCH_Inpatient) as float)/cast(count(NCH_Inpatient) as float) as percent_NCH_Inpatient,
           cast(sum(PRIM_DX_HCUP_CHRONIC) AS float)/cast(count(PRIM_DX_HCUP_CHRONIC) as float) as percent_HCUP_Chronic,
           cast(sum(PRIM_DX_BH) as float)/cast(count(PRIM_DX_BH) as float) as percent_BH,
           cast(sum(ABD_FLAG) as float)/cast(count(ABD_FLAG) as float) as percent_ABD,
           cast(sum(PREV_DIABETES_ED) as float)/cast(count(PREV_DIABETES_ED) as float) as percent_DIABETES,
           cast(sum(homehealth_flag) as float)/cast(count(homehealth_flag) as float) as percent_HOMEHEALTH,
           cast(sum(NCH_ATTRIBUTED_ASSIGNED) as float)/cast(count(NCH_ATTRIBUTED_ASSIGNED) as float) as percent_NCHATTR,
           cast(sum(IP_LAST_12_FLAG) as float)/cast(count(IP_LAST_12_FLAG) as float) as PERCENT_IP_LAST_12,
           cast(sum(AVOIDABLE_ED_LAST_12_FLAG) as float)/cast(count(AVOIDABLE_ED_LAST_12_FLAG) as float) as percent_AVOIDL12,
           sum(a.FRANKLIN_COUNTY) AS FRANKLIN_COUNTY_SUM,
           count(a.FRANKLIN_COUNTY) as FRANKLIN_COUNTY_COUNT,
           sum(NCH_Previous) AS NCH_Previous_SUM,
           count(NCH_Previous) as NCH_Previous_COUNT,
           sum(OVER_10K_PAID) AS OVER_10K_PAID_SUM,
           count(OVER_10K_PAID) as OVER_10K_PAID_COUNT,        
           sum(ED_VISIT_FLAG_5) AS ED_VISIT_FLAG_5_SUM,
           count(ED_VISIT_FLAG_5) as ED_VISIT_FLAG_5_COUNT,        
           sum(NCH_Inpatient) AS NCH_Inpatient_SUM,
           count(NCH_Inpatient) as NCH_Inpatient_COUNT,        
           sum(PRIM_DX_HCUP_CHRONIC) AS PRIM_DX_HCUP_CHRONIC_SUM,
           count(PRIM_DX_HCUP_CHRONIC) as PRIM_DX_HCUP_CHRONIC_COUNT,        
           sum(PRIM_DX_BH) AS PRIM_DX_BH_SUM,
           count(PRIM_DX_BH) as PRIM_DX_BH_COUNT,        
           sum(ABD_FLAG) AS ABD_FLAG_SUM,
           count(ABD_FLAG) as ABD_FLAG_COUNT,        
           sum(PREV_DIABETES_ED) AS PREV_DIABETES_ED_SUM,
           count(PREV_DIABETES_ED) as PREV_DIABETES_ED_COUNT,        
           sum(homehealth_flag) AS homehealth_flag_SUM,
           count(homehealth_flag) as homehealth_flag_COUNT,        
           sum(NCH_ATTRIBUTED_ASSIGNED) AS NCH_ATTRIBUTED_ASSIGNED_SUM,
           count(NCH_ATTRIBUTED_ASSIGNED) as NCH_ATTRIBUTED_ASSIGNED_COUNT,        
           sum(IP_LAST_12_FLAG) AS IP_LAST_12_FLAG_SUM,
           count(IP_LAST_12_FLAG) as IP_LAST_12_FLAG_COUNT,        
           sum(AVOIDABLE_ED_LAST_12_FLAG) AS AVOIDABLE_ED_LAST_12_FLAG_SUM,
           count(AVOIDABLE_ED_LAST_12_FLAG) as AVOIDABLE_ED_LAST_12_FLAG_COUNT       




           from 
           matched_data a
           group by
           a.ENROLLED_IN_PERIOD
           
           
           
           ')

match_compare <- sqldf("select
                       *,
                       case when ENROLLED_IN_PERIOD = '1' THEN 'ENROLLED' ELSE 'NOT ENROLLED' END AS ENROLLED_STATUS,
                       'Before Match' as Match_Status
                       from
                       df1
                       
                       union

                       select
                       *,
                       case when ENROLLED_IN_PERIOD = '1' then 'ENROLLED' ELSE 'NOT ENROLLED' END AS ENROLLED_STATUS,
                       'After Match' as Match_Status
                       from
                       df3")
match_compare$ENROLLED_STATUS <-as.factor(match_compare$ENROLLED_STATUS)
match_compare$Match_Status <- as.factor(match_compare$Match_Status)
match_compare$Match_Status = factor(match_compare$Match_Status, levels = c("Before Match","After Match"))

ENROLLED_DF<-subset(df2,ENROLLED_IN_PERIOD==1)
NOT_ENROLLED_DF <- subset(df2,ENROLLED_IN_PERIOD==0)

kable(match_compare, "html") %>%
    kable_styling(bootstrap_options = c("striped","hover","condensed","responsive")) %>%
    scroll_box(width="910px",height="300px")

```
</div>


#### **Percent living in Franklin County**

<div class="fold s">
```{r}

ggplot(data = match_compare, aes(x=ENROLLED_STATUS, percent_franklin, fill = ENROLLED_STATUS)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Match_Status) +
  theme_bw() +
  labs(x="", y="Percent Residing in Franklin County", legend = "Enrolled Status")
  
t<-binom.test(NOT_ENROLLED_DF$FRANKLIN_COUNTY_SUM,NOT_ENROLLED_DF$FRANKLIN_COUNTY_COUNT,ENROLLED_DF$percent_franklin)
cat("After-Match p Value = ",t$p.value)

```

</div>

#### **Percent of Patients Previously a Nationwide Children's Patient**

<div class="fold s">
```{r warning=FALSE}
ggplot(data = match_compare, aes(x=ENROLLED_STATUS, NCH_PREV_COUNT, fill = ENROLLED_STATUS)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Match_Status) +
  theme_bw() +
  labs(x="", y="Percent Previously an NCH Patient", legend = "Enrolled Status")

t<-binom.test(NOT_ENROLLED_DF$NCH_Previous_SUM,NOT_ENROLLED_DF$NCH_Previous_COUNT,ENROLLED_DF$NCH_PREV_COUNT)
cat("After-Match p Value = ",t$p.value)
```

</div>

#### **Percent Over $10,000 Paid Previous 12 Months**

<div class="fold s">
```{r}

ggplot(data = match_compare, aes(x=ENROLLED_STATUS, PERCENT_OVER_10K, fill = ENROLLED_STATUS)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Match_Status) +
  theme_bw() +
  labs(x="", y="Over $10,000 Paid Previous 12 Months", legend = "Enrolled Status")

t<-binom.test(NOT_ENROLLED_DF$OVER_10K_PAID_SUM,NOT_ENROLLED_DF$OVER_10K_PAID_COUNT,ENROLLED_DF$PERCENT_OVER_10K)
cat("After-Match p Value = ",t$p.value)
```

</div>


#### **Percent with 5 or more ED Visits in the Previous 12 Months**

<div class="fold s">
```{r}

ggplot(data = match_compare, aes(x=ENROLLED_STATUS, PERCENT_ED_5, fill = ENROLLED_STATUS)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Match_Status) +
  theme_bw() +
  labs(x="", y="5+ ED Visits Previous 12 Months", legend = "Enrolled Status")

t<-binom.test(NOT_ENROLLED_DF$ED_VISIT_FLAG_5_SUM,NOT_ENROLLED_DF$ED_VISIT_FLAG_5_COUNT,ENROLLED_DF$PERCENT_ED_5)
cat("After-Match p Value = ",t$p.value)

```

</div>


#### **Percent Previously Inpatient at Nationwide Children's**

<div class="fold s">
```{r}

ggplot(data = match_compare, aes(x=ENROLLED_STATUS, percent_NCH_Inpatient, fill = ENROLLED_STATUS)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Match_Status) +
  theme_bw() +
  labs(x="", y="Percent Previously Inpatient at NCH", legend = "Enrolled Status")

t<-binom.test(NOT_ENROLLED_DF$NCH_Inpatient_SUM,NOT_ENROLLED_DF$NCH_Inpatient_COUNT,ENROLLED_DF$percent_NCH_Inpatient)
cat("After-Match p Value = ",t$p.value)

```

</div>

#### **Percent with a Chronic Condition**

<div class="fold s">
```{r}

ggplot(data = match_compare, aes(x=ENROLLED_STATUS, percent_HCUP_Chronic, fill = ENROLLED_STATUS)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Match_Status) +
  theme_bw() +
  labs(x="", y="Percent with HCUP Chronic Primary Diagnosis", legend = "Enrolled Status")


t<-binom.test(NOT_ENROLLED_DF$PRIM_DX_HCUP_CHRONIC_SUM,NOT_ENROLLED_DF$PRIM_DX_HCUP_CHRONIC_COUNT,ENROLLED_DF$percent_HCUP_Chronic)
cat("After-Match p Value = ",t$p.value)

```

</div>

#### **Percent with a Behavioral Health Condition**

<div class="fold s">
```{r}

ggplot(data = match_compare, aes(x=ENROLLED_STATUS, percent_BH, fill = ENROLLED_STATUS)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Match_Status) +
  theme_bw() +
  labs(x="", y="Percent with Behavioral Health Primary Diagnosis", legend = "Enrolled Status")


t<-binom.test(NOT_ENROLLED_DF$PRIM_DX_BH_SUM,NOT_ENROLLED_DF$PRIM_DX_BH_COUNT,ENROLLED_DF$percent_BH)
cat("After-Match p Value = ",t$p.value)

```

</div>

#### **Percent in Aged, Blind and Disabled (ABD) Medicaid Population**

<div class="fold s">
```{r}

ggplot(data = match_compare, aes(x=ENROLLED_STATUS, percent_ABD, fill = ENROLLED_STATUS)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Match_Status) +
  theme_bw() +
  labs(x="", y="Percent ABD", legend = "Enrolled Status")

t<-binom.test(NOT_ENROLLED_DF$ABD_FLAG_SUM,NOT_ENROLLED_DF$ABD_FLAG_COUNT,ENROLLED_DF$percent_ABD)
cat("After-Match p Value = ",t$p.value)

```

</div>

#### **Percent with History of Home Health Services**

<div class="fold s">
```{r}

ggplot(data = match_compare, aes(x=ENROLLED_STATUS, percent_HOMEHEALTH, fill = ENROLLED_STATUS)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Match_Status) +
  theme_bw() +
  labs(x="", y="Percent Using Home Health", legend = "Enrolled Status")


t<-binom.test(NOT_ENROLLED_DF$homehealth_flag_SUM,NOT_ENROLLED_DF$homehealth_flag_COUNT,ENROLLED_DF$percent_HOMEHEALTH)
cat("After-Match p Value = ",t$p.value)

```

</div>

#### **Percent Attributed or Assigned to NCH Primary Care**

<div class="fold s">
```{r}

ggplot(data = match_compare, aes(x=ENROLLED_STATUS, percent_NCHATTR, fill = ENROLLED_STATUS)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Match_Status) +
  theme_bw() +
  labs(x="", y="Percent Attributed or Assigned to NCH", legend = "Enrolled Status")


t<-binom.test(NOT_ENROLLED_DF$NCH_ATTRIBUTED_ASSIGNED_SUM,NOT_ENROLLED_DF$NCH_ATTRIBUTED_ASSIGNED_COUNT,ENROLLED_DF$percent_NCHATTR)
cat("After-Match p Value = ",t$p.value)
```

</div>

#### **Percent with an Avoidable Emergency Visit in the Previous 12 Months**

<div class="fold s">
```{r}

ggplot(data = match_compare, aes(x=ENROLLED_STATUS, percent_AVOIDL12, fill = ENROLLED_STATUS)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Match_Status) +
  theme_bw() +
  labs(x="", y="Percent with Avoidable ED Last 12 Months", legend = "Enrolled Status")

t<-binom.test(NOT_ENROLLED_DF$AVOIDABLE_ED_LAST_12_FLAG_SUM,NOT_ENROLLED_DF$AVOIDABLE_ED_LAST_12_FLAG_COUNT,ENROLLED_DF$percent_AVOIDL12)
cat("After-Match p Value = ",t$p.value)

```
</div>

#### **Percent Inpatient in the Previous 12 Months**

<div class="fold s">
```{r}

ggplot(data = match_compare, aes(x=ENROLLED_STATUS, PERCENT_IP_LAST_12, fill = ENROLLED_STATUS)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Match_Status) +
  theme_bw() +
  labs(x="", y="Percent with Avoidable ED Last 12 Months", legend = "Enrolled Status")

t<-binom.test(NOT_ENROLLED_DF$IP_LAST_12_FLAG_SUM,NOT_ENROLLED_DF$IP_LAST_12_FLAG_COUNT,ENROLLED_DF$PERCENT_IP_LAST_12)
cat("After-Match p Value = ",t$p.value)

```
</div>


## **Evaluation of Effectiveness**

Now that the removal of the selection bias has been verified, it's possible to compare outcomes between the treated and non-treated populations. To do this, a separate data set is needed that contains the measurements of avoidable emergency visits after the anchor date.

<div class="fold s o">
```{r}
meas_data <-read.csv("ED_MEAS.csv",sep=",")
meas_data[c("AVOIDABLE_ED_MEAS")][is.na(meas_data[c("AVOIDABLE_ED_MEAS")])] <- 0
names(meas_data)
```
</div>

There are three columns of interest in the measurement data:

* **MEDICAIDID** - The unqiue identifier for each member.
* **member_months_meas** - The number of eligible months for the member in the measurement period.
* **AVOIDABLE_ED_MEAS** - The number of avoidable ED visits in the measurement period for the member.

To normalize the results for the entire group, the measurements will be calcuated as a rate per 1,000 member months.

<div class="fold s o">
```{r}

meas_data$AVOIDABLE_ED_MEAS = as.numeric(meas_data$AVOIDABLE_ED_MEAS)
meas_data$member_months_meas = as.numeric(meas_data$member_months_meas)
meas_summary <- sqldf(
'
select
a.ENROLLED_IN_PERIOD,
case when a.ENROLLED_IN_PERIOD = "1" THEN "Enrolled" ELSE "Not Enrolled" END AS ENROLLED_STATUS,
sum(b.AVOIDABLE_ED_MEAS) as AVOIDABLE_ED_VISITS,
sum(b.member_months_meas) as MEMBER_MONTHS,
sum(b.AVOIDABLE_ED_MEAS)*1000/sum(b.member_months_meas) AS AVOIDABLE_ED_PER_1000

from
matched_data a

left join
meas_data b
on a.MEDICAIDID = b.MEDICAIDID

group by
a.ENROLLED_IN_PERIOD
'

)

meas_detail = sqldf(
  
'
select
a.MEDICAIDID,
a.ENROLLED_IN_PERIOD,
b.AVOIDABLE_ED_MEAS

from
matched_data a

left join
meas_data b
on a.MEDICAIDID = b.MEDICAIDID

'  
  
  
)


kable(meas_summary, "html") %>%
    kable_styling(bootstrap_options = c("striped","hover","condensed","responsive")) %>%
    scroll_box(width="910px",height="150px")

```
</div>

#### **Results**
<div class="fold s">
```{r}

ggplot(data = meas_summary, aes(x=ENROLLED_STATUS, AVOIDABLE_ED_PER_1000, fill = ENROLLED_STATUS,label = round(AVOIDABLE_ED_PER_1000,digits=1))) +
  geom_bar(stat = "identity") +
  theme_bw() +
  geom_text(nudge_y = 3) +
  labs(x="", y="Avoidable ED Visits Per 1,000 Member Months", legend = "Enrolled Status")

meas_detail$AVOIDABLE_ED_MEAS <- as.numeric(meas_detail$AVOIDABLE_ED_MEAS)
meas_detail$ENROLLED_IN_PERIOD <- as.numeric(meas_detail$ENROLLED_IN_PERIOD)
meas_detail[c("AVOIDABLE_ED_MEAS")][is.na(meas_detail[c("AVOIDABLE_ED_MEAS")])] <- 0


no_ed_visits <- c(meas_summary$AVOIDABLE_ED_VISITS)
rate <- c(meas_summary$AVOIDABLE_ED_PER_1000)
pt<-rateratio.test(no_ed_visits,rate)
cat("Comparison p Value = ",pt$p.value)

```
</div>

Based on the propensity match conducted in this analysis, it can be concluded that the Care Coordination program at Partners for Kids does not appear effective in reducing avoidable emergency utilization.

#### **Considerations**

While the inclusion criteria for care coordination outreach were used as covariates in this analysis, they were set to meet a contractual obligation to increase enrollment in the program. Therefore, a wide net was intentionally cast across the delegated managed care population to ensure enrollment volumes could meet those obligations. Consequently, despite the accuracy of the propensity match, confounding may still exist. There may be unknown attributes that make a member more likely to enroll. I would expect this to be especially true in a health care claims dataset, where the amount of individual-level attributes is so large.



