if object_id('PFKCC.dbo.DS18_PREVIOUS_NCH') is not null drop table PFKCC..DS18_PREVIOUS_NCH

--add diagnostic information

SELECT
eo.MEDICAIDID,
eo.COUNTY,
eo.ZIP,
eo.abd_months,
CASE WHEN eo.pcp_method = 'Attributed' THEN 1 ELSE 0 END AS USES_PCP,
ENROLLMENT_DATE,
EVER_ENROLLED,
ENROLLED_IN_PERIOD,
MALE,
eo.MRN,
PREVIOUS_ATTEMPTS,
PREVIOUSLY_ENROLLED,
eo.first_episode_start,
eo.anchor_date,
eo.age_at_anchor,
eo.CONT_ENROLLMENT_MONTHS,
eo.ABD_FLAG,
case when eo.county='FRANKLIN' then 1 else 0 end as franklin_county,
max(case when mm.mrn is not null then 1 else 0 end) as NCH_Previous,
max(case 
				WHEN (TC.DIAG1 LIKE 'J45%' OR TC.DIAG1 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG2 LIKE 'J45%' OR TC.DIAG2 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG3 LIKE 'J45%' OR TC.DIAG3 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG4 LIKE 'J45%' OR TC.DIAG4 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG5 LIKE 'J45%' OR TC.DIAG5 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG6 LIKE 'J45%' OR TC.DIAG6 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG7 LIKE 'J45%' OR TC.DIAG7 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG8 LIKE 'J45%' OR TC.DIAG8 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG9 LIKE 'J45%' OR TC.DIAG9 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG10 LIKE 'J45%' OR TC.DIAG10 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG11 LIKE 'J45%' OR TC.DIAG11 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG12 LIKE 'J45%' OR TC.DIAG12 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG13 LIKE 'J45%' OR TC.DIAG13 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG14 LIKE 'J45%' OR TC.DIAG14 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG15 LIKE 'J45%' OR TC.DIAG15 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG16 LIKE 'J45%' OR TC.DIAG16 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG17 LIKE 'J45%' OR TC.DIAG17 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG18 LIKE 'J45%' OR TC.DIAG18 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG19 LIKE 'J45%' OR TC.DIAG19 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG20 LIKE 'J45%' OR TC.DIAG20 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG21 LIKE 'J45%' OR TC.DIAG21 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG22 LIKE 'J45%' OR TC.DIAG22 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG23 LIKE 'J45%' OR TC.DIAG23 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG24 LIKE 'J45%' OR TC.DIAG24 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				WHEN (TC.DIAG25 LIKE 'J45%' OR TC.DIAG25 LIKE '493%')AND TC.SUBCAT = 15 THEN 1
				ELSE 0 END) AS ASTHMA_FLAG,
max(case 
					WHEN (TC.DIAG1 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG1 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG2 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG2 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG3 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG3 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG4 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG4 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG5 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG5 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG6 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG6 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG7 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG7 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG8 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG8 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG9 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG9 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG10 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG10 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG11 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG11 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG12 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG12 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG13 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG13 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG14 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG14 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG15 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG15 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG16 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG16 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG17 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG17 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG18 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG18 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG19 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG19 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG20 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG20 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG21 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG21 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG22 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG22 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG23 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG23 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG24 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG24 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1
					WHEN (TC.DIAG25 BETWEEN 'Z62.81' AND 'Z62.819' OR TC.DIAG25 BETWEEN '249' AND '250.99') AND TC.SUBCAT = 15 THEN 1

				ELSE 0 END) AS DIABETES_FLAG,
max(case when tc.majcat=29 then 1 else 0 end) as homehealth_flag,
max(case 
				when tc.Diag1 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag1 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag2 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag2 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag3 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag3 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag4 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag4 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag5 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag5 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag6 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag6 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag7 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag7 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag8 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag8 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag9 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag9 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag10 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag10 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag11 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag11 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag12 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag12 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag13 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag13 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag14 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag14 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag15 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag15 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag16 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag16 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag17 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag17 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag18 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag18 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag19 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag19 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag20 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag20 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag21 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag21 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag22 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag22 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag23 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag23 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag24 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag24 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				when tc.Diag25 BETWEEN 'Z62.81' AND 'Z62.819' or tc.Diag25 BETWEEN 'V60.81' AND 'V60.81' THEN 1
				ELSE 0 END) AS NOT_WITH_PARENTS,
max(case 
				when tc.Diag1 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag1 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag2 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag2 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag3 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag3 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag4 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag4 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag5 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag5 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag6 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag6 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag7 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag7 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag8 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag8 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag9 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag9 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag10 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag10 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag11 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag11 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag12 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag12 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag13 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag13 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag14 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag14 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag15 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag15 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag16 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag16 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag17 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag17 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag18 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag18 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag19 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag19 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag20 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag20 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag21 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag21 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag22 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag22 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag23 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag23 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag24 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag24 BETWEEN '995.5' AND '995.59'THEN 1
				when tc.Diag25 IN ('T76', 'T76.0', 'T76.01', 'T76.01XA', 'T76.01XD', 'T76.01XS', 'T76.02', 'T76.02XA', 'T76.02XD', 'T76.02XS', 'T76.1', 'T76.11', 'T76.11XA', 'T76.11XD', 'T76.11XS', 'T76.12', 'T76.12XA', 'T76.12XD', 'T76.12XS', 'T76.2', 'T76.21', 'T76.21XA', 'T76.21XD', 'T76.21XS', 'T76.22', 'T76.22XA', 'T76.22XD', 'T76.22XS', 'T76.3', 'T76.31', 'T76.31XA', 'T76.31XD', 'T76.31XS', 'T76.32', 'T76.32XA', 'T76.32XD', 'T76.32XS', 'T76.9', 'T76.91', 'T76.91XA', 'T76.91XD', 'T76.91XS', 'T76.92', 'T76.92XA', 'T76.92XD', 'T76.92XS', 'Z62.81', 'Z62.810', 'Z62.811', 'Z62.812', 'Z62.819')or tc.Diag25 BETWEEN '995.5' AND '995.59'THEN 1
				ELSE 0 END) AS ABUSE_NEGLECT,
				max(cen.percent_urban) as ZIP_PERCENT_URBAN,
				max(cen.percent_white) as ZIP_PERCENT_WHITE,
				max(case when ed.memberid is not null then 1 else 0 end) as PREV_AVOIDABLE_ED_VISIT,
				count(distinct case when ed.date_of_first_service between dateadd(m,-12,CAST(eo.anchor_date AS DATE)) and eo.anchor_date then concat(ed.memberid,ed.date_of_first_service,ed.facility_name_standard) else null end) as AVOIDABLE_ED_LAST_12_CNT,
				MAX(case when ed.date_of_first_service between dateadd(m, -12,CAST(eo.anchor_date AS DATE)) and eo.anchor_date then 1 ELSE 0 end) as AVOIDABLE_ED_LAST_12_FLAG


INTO PFKCC.dbo.DS18_PREVIOUS_NCH
FROM
PFKCC.dbo.DS18_ENROLLMENT_OUTREACH eo

LEFT JOIN
PFKCC..MRN_CREATED_DATES mm
on eo.MRN = mm.MRN
and mm.REC_CREATE_DATE < ISNULL(CAST(eo.first_episode_start as datetime),eo.anchor_date) - 14

left join
pfkcc..MRN_CREATED_DATES mm1
on mm1.mrn = eo.mrn

left join
DWPFK..tblClaims tc
on tc.medicaidid = eo.MedicaidID
and tc.SvcDt < eo.anchor_date

LEFT JOIN
PFKCC.dbo.CENSUS_TRACT_DATA_2010 cen
on rtrim(cen.ZIPCODE) = eo.ZIP

left join
pfkcc..DS18_ED_COUNT ed
on eo.MedicaidID = ed.MEDICAIDID
and ed.DATE_OF_FIRST_SERVICE < eo.anchor_date
and ed.AVOIDABLE_FLAG = 1

where
eo.exclude_flag = 0
and eo.anchor_date is not null
and CONT_ENROLLMENT_MONTHS >= 12

group by
eo.MEDICAIDID,
eo.ZIP,
ENROLLMENT_DATE,
EVER_ENROLLED,
ENROLLED_IN_PERIOD,
MALE,
eo.MRN,
PREVIOUS_ATTEMPTS,
PREVIOUSLY_ENROLLED,
eo.first_episode_start,
eo.anchor_date,
eo.age_at_anchor,
eo.CONT_ENROLLMENT_MONTHS,
eo.ABD_FLAG,
eo.COUNTY,
eo.abd_months,
eo.pcp_method